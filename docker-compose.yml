services:
  postgres:
    image: postgres:15-alpine
    container_name: faceless-db
    environment:
      POSTGRES_DB: faceless
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    # SECURITY: No ports exposed - only accessible within Docker network
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./migrations:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: faceless-redis
    # SECURITY: No ports exposed - only accessible within Docker network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5

  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: faceless-api
    ports:
      - "127.0.0.1:8080:8080"  # Only localhost - use reverse proxy for public access
    environment:
      API_PORT: 8080
      WORKER_ENABLED: "true"
      BACKEND_API_KEY: ${BACKEND_API_KEY:-}
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS:-}
      DATABASE_URL: "postgresql://postgres:postgres@postgres:5432/faceless?sslmode=disable"
      REDIS_URL: "redis://redis:6379"
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_SERVICE_KEY: ${SUPABASE_SERVICE_KEY}
      SUPABASE_STORAGE_BUCKET: ${SUPABASE_STORAGE_BUCKET:-faceless-videos}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      ELEVENLABS_API_KEY: ${ELEVENLABS_API_KEY:-}
      ELEVENLABS_VOICE_ID: ${ELEVENLABS_VOICE_ID:-}
      CARTESIA_API_KEY: ${CARTESIA_API_KEY:-}
      CARTESIA_API_URL: ${CARTESIA_API_URL:-https://api.cartesia.ai/v1}
      CARTESIA_VOICE_ID: ${CARTESIA_VOICE_ID:-}
      GEMINI_API_KEY: ${GEMINI_API_KEY}
      GEMINI_STYLE_REFERENCE_IMAGE: ${GEMINI_STYLE_REFERENCE_IMAGE:-assets/style-reference/sample.jpeg}
      VEO_ENABLED: ${VEO_ENABLED:-false}
      VEO_MODEL: ${VEO_MODEL:-veo-3.1-generate-preview}
      XAI_VIDEO_ENABLED: ${XAI_VIDEO_ENABLED:-false}
      XAI_API_KEY: ${XAI_API_KEY:-}
      BACKGROUND_MUSIC_PATH: ${BACKGROUND_MUSIC_PATH:-assets/music/music.mp3}
      MAX_CONCURRENT_JOBS: ${MAX_CONCURRENT_JOBS:-3}
    deploy:
      resources:
        limits:
          memory: 8g
    shm_size: '512m'
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - temp_data:/tmp/faceless

volumes:
  postgres_data:
  temp_data:
