services:
  redis:
    image: redis:7-alpine
    container_name: episod-redis
    restart: unless-stopped
    networks:
      - episod-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: episod-api
    restart: unless-stopped
    dns:
      - 8.8.8.8
      - 1.1.1.1
    ports:
      - "127.0.0.1:8080:8080"  # Only expose to localhost, Nginx will proxy
    environment:
      API_PORT: 8080
      WORKER_ENABLED: "true"
      BACKEND_API_KEY: ${BACKEND_API_KEY}
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS}
      # Database uses Supabase Postgres â€” set DATABASE_URL in .env with ?sslmode=require
      DATABASE_URL: ${DATABASE_URL}
      REDIS_URL: "redis://redis:6379"
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_SERVICE_KEY: ${SUPABASE_SERVICE_KEY}
      SUPABASE_STORAGE_BUCKET: ${SUPABASE_STORAGE_BUCKET:-files}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      ELEVENLABS_API_KEY: ${ELEVENLABS_API_KEY:-}
      ELEVENLABS_VOICE_ID: ${ELEVENLABS_VOICE_ID:-}
      CARTESIA_API_KEY: ${CARTESIA_API_KEY:-}
      CARTESIA_API_URL: ${CARTESIA_API_URL:-https://api.cartesia.ai/v1}
      CARTESIA_VOICE_ID: ${CARTESIA_VOICE_ID:-}
      GEMINI_API_KEY: ${GEMINI_API_KEY}
      VEO_ENABLED: ${VEO_ENABLED:-false}
      VEO_MODEL: ${VEO_MODEL:-veo-3.1-generate-preview}
      XAI_VIDEO_ENABLED: ${XAI_VIDEO_ENABLED:-false}
      XAI_API_KEY: ${XAI_API_KEY:-}
      RENDER_RESOLUTION: ${RENDER_RESOLUTION:-1080p}
      BACKGROUND_MUSIC_PATH: ${BACKGROUND_MUSIC_PATH:-assets/music/music.mp3}
      MAX_CONCURRENT_JOBS: ${MAX_CONCURRENT_JOBS:-3}
    deploy:
      resources:
        limits:
          memory: 8g
    shm_size: '512m'
    depends_on:
      redis:
        condition: service_healthy
    volumes:
      - temp_data:/tmp/episod
    networks:
      - episod-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  episod-network:
    driver: bridge

volumes:
  temp_data:
